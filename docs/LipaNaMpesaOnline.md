### Lipa na M-Pesa Online Payment API 
Lipa na M-Pesa Online Payment API Is used to initiate a M-Pesa transaction on behalf of a customer using STK Push. This is the same technique mySafaricom App uses whenever the app is used to make payments.

### Lipa na M-Pesa Online Payment - Request Parameters

	##BusinessShortCode 	
The organization shortcode used to receive the transaction.

	##Password 	
The password for encrypting the request. This is generated by base64 encoding BusinessShortcode, Passkey and Timestamp.

	##Timestamp 	
The timestamp of the transaction in the format yyyymmddhhiiss.

	##TransactionType 	
The transaction type to be used for this request. Only CustomerPayBillOnline is supported.

	##Amount 	
The amount to be transacted.

	##PartyA 	
The MSISDN sending the funds.

	##PartyB 	
The organization shortcode receiving the funds

	##PhoneNumber 	
The MSISDN sending the funds.

	##CallBackURL 	
The url to where responses from M-Pesa will be sent to.

	##AccountReference 	
Used with M-Pesa PayBills.

	##TransactionDesc 	
A description of the transaction.


### Sample PHP implementation request

```
	<?php

	$url = 'https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest';

	$curl = curl_init();
	curl_setopt($curl, CURLOPT_URL, $url);
	curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-Type:application/json','Authorization:Bearer ACCESS_TOKEN')); //setting custom header


	$curl_post_data = array(
	  //Fill in the request parameters with valid values
	  'BusinessShortCode' => ' ',
	  'Password' => ' ',
	  'Timestamp' => ' ',
	  'TransactionType' => 'CustomerPayBillOnline',
	  'Amount"' => ' ',
	  'PartyA' => ' ',
	  'PartyB' => ' ',
	  'PhoneNumber' => ' ',
	  'CallBackURL' => 'https://ip_address:port/callback',
	  'AccountReference' => ' ',
	  'TransactionDesc' => ' '
	);

	$data_string = json_encode($curl_post_data);

	curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($curl, CURLOPT_POST, true);
	curl_setopt($curl, CURLOPT_POSTFIELDS, $data_string);

	$curl_response = curl_exec($curl);
	print_r($curl_response);

	echo $curl_response;
	?>
```

### Lipa na M-Pesa Online Payment - Response Parameters

#  Parameter 			Description
	MerchantRequestID 	Merchant Request ID

	CheckoutRequestID 	Check out Request ID

	ResponseCode 		Response Code

	ResultDesc 			Result Desc

	ResponseDescription Response Description message

	ResultCode 			Result Code

###Sample JSON Response

```
// A cancelled request
	{

	  "Body":{
	    "stkCallback":{
	      "MerchantRequestID":"8555-67195-1",
	      "CheckoutRequestID":"ws_CO_27072017151044001",
	      "ResultCode":1032,
	      "ResultDesc":"[STK_CB - ]Request cancelled by user"
	    }
	  }
	}

// An accepted request
	{

	  "Body":{
	    "stkCallback":{
	      "MerchantRequestID":"19465-780693-1",
	      "CheckoutRequestID":"ws_CO_27072017154747416",
	      "ResultCode":0,
	      "ResultDesc":"The service request is processed successfully.",
	      "CallbackMetadata":{
	        "Item":[
	          {
	            "Name":"Amount",
	            "Value":1
	          },
	          {
	            "Name":"MpesaReceiptNumber",
	            "Value":"LGR7OWQX0R"
	          },
	          {
	            "Name":"Balance"
	          },
	          {
	            "Name":"TransactionDate",
	            "Value":20170727154800
	          },
	          {
	            "Name":"PhoneNumber",
	            "Value":254721566839
	          }
	        ]
	      }
	    }
	  }
	}

```





### Prerequisites to implementation
1. Make sure you have installed this package
2. You have read the configuration guidelines specific to Lipa na mpesa and taken the necessary steps.
3. You have successfully acquired production credentials from safaricom. If not you can go ahead and use the sandbox credentials that comes preconfigured on installation.

#### Payment flow involved with this endpoint.
1. Your system initiates a payment request to you on behalf of client and sends it to safaricom.
2. Safaricom sends the request to the client requesting them to authorize the transaction by entering their M-PESA PIN.
3. If client enters their correct M-PESA PIN, safaricom respond to your system with details regarding the transaction. This is made possible by sending an internet accessible URL via a CallBackUrl.

#### Usage
Note this package allows you to override preconfigured parameters for this endpoint. For all supported options check the docs here https://developer.safaricom.co.ke/lipa-na-m-pesa-online/apis/post/stkpush/v1/processrequest

##### Using vanilla php


##### Using Laravel.
```
use STKPush;

class CheckoutController{

   public function checkout(){
     STKPush::submit([
      'amount' => 20,
      'phoneNumber' => '254722000000',
      'accountReference' => 'INVOICEID', 
      'transactionDesc' => 'Payment for my service'
     ]); 
   }
}

```

### Known issues with this endpoint
1. There exists some SIM cards that are not yet supported by this. All your requests to such SIM Cards will fail with `[STK DS timeout]`.
2. Making multiple subsequent requests to the same phone number causes the initial request to timeout and the STK Prompt to user not to respond to safaricom even though the user entered the correct M-PESA pin.
